name: Issue Automation

on:
  workflow_call:
    inputs:
      project-number:
        description: "GitHub Project number"
        type: string
        required: true
      status-backlog:
        description: "Status name for Backlog"
        type: string
        default: "Backlog"
      status-progress:
        description: "Status name for In Progress"
        type: string
        default: "Progress"
      status-ready:
        description: "Status name for Ready"
        type: string
        default: "Ready"
      event-action:
        description: "The action that triggered the workflow"
        type: string
        required: true
      issue-number:
        description: "Issue number"
        type: string
        required: true
      issue-node-id:
        description: "Issue node ID for GraphQL"
        type: string
        required: true
      issue-user-login:
        description: "Issue creator login"
        type: string
        required: true
      label-name:
        description: "Label name (for labeled event)"
        type: string
        default: ""
      has-bug-label:
        description: "Whether issue has bug label on creation"
        type: boolean
        default: false
    secrets:
      GH_PAT:
        description: "GitHub Personal Access Token with project permissions"
        required: true

jobs:
  assign-on-open:
    if: inputs.event-action == 'opened'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Assign issue to creator
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue-number }}
          USER_LOGIN: ${{ inputs.issue-user-login }}
          REPO: ${{ github.repository }}
        run: |
          gh issue edit "$ISSUE_NUMBER" \
            --add-assignee "$USER_LOGIN" \
            --repo "$REPO"

      - name: Checkout for composite action
        uses: actions/checkout@v4
        with:
          repository: KubrickCode/workflow-toolkit
          ref: main

      - name: Add to project with status
        uses: ./.github/actions/project-status
        with:
          action: add-to-project
          issue-node-id: ${{ inputs.issue-node-id }}
          target-status: ${{ inputs.has-bug-label && inputs.status-ready || inputs.status-backlog }}
          project-number: ${{ inputs.project-number }}
          github-token: ${{ secrets.GH_PAT }}

  bug-to-ready:
    if: inputs.event-action == 'labeled' && inputs.label-name == 'bug'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout for composite action
        uses: actions/checkout@v4
        with:
          repository: KubrickCode/workflow-toolkit
          ref: main

      - name: Get project data
        id: project
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          OWNER: ${{ github.repository_owner }}
          PROJECT_NUMBER: ${{ inputs.project-number }}
        run: |
          RESULT=$(./.github/actions/project-status/scripts/get-project-data.sh \
            "$OWNER" \
            "$PROJECT_NUMBER" \
            "Status")

          PROJECT_ID=$(echo "$RESULT" | grep "^project_id=" | cut -d= -f2-)
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Check current status
        id: check
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          PROJECT_ID: ${{ steps.project.outputs.project_id }}
          CONTENT_ID: ${{ inputs.issue-node-id }}
        run: |
          RESULT=$(./.github/actions/project-status/scripts/get-item-status.sh \
            "$PROJECT_ID" \
            "$CONTENT_ID" \
            "Status" \
            "10")

          CURRENT_STATUS=$(echo "$RESULT" | grep "^current_status=" | cut -d= -f2-)
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
          echo "Current status: $CURRENT_STATUS"

          # Check if status should be updated
          if [ -z "$CURRENT_STATUS" ] || \
             [ "$CURRENT_STATUS" = "Backlog" ] || \
             [ "$CURRENT_STATUS" = "${{ inputs.status-backlog }}" ]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "Will update to Ready"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "Status is '$CURRENT_STATUS' - skipping update"
          fi

      - name: Move bug to Ready
        if: steps.check.outputs.should_update == 'true'
        uses: ./.github/actions/project-status
        with:
          action: update-status
          issue-node-id: ${{ inputs.issue-node-id }}
          target-status: ${{ inputs.status-ready }}
          project-number: ${{ inputs.project-number }}
          github-token: ${{ secrets.GH_PAT }}

  remove-needs-thinking-on-close:
    if: inputs.event-action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Remove needs thinking label if exists
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ inputs.issue-number }}
          REPO: ${{ github.repository }}
        run: |
          if gh issue view "$ISSUE_NUMBER" --repo "$REPO" --json labels --jq '.labels[].name' | grep -q "needs thinking"; then
            gh issue edit "$ISSUE_NUMBER" \
              --remove-label "needs thinking" \
              --repo "$REPO"
            echo "Removed needs thinking label"
          else
            echo "No needs thinking label found"
          fi
